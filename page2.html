<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Gift Exchange Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Replace with your Firebase config
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        let db = null;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase init failed:", error);
            alert("Firebase not set up. Using local storage only (no shared data).");
        }

        window.db = db;
    </script>
</head>
<body>
    <div class="container">
        <img src="https://via.placeholder.com/800x300/228B22/FFFFFF?text=Christmas+Tree" alt="Christmas Tree" class="top-image">
        
        <div class="user-info">
            <h2 id="userName"></h2>
            <label for="wishlist">Your Wishlist:</label>
            <textarea id="wishlist" placeholder="Add your gift wishes here..."></textarea>
            <button id="submitWishlist">Submit Wishlist</button>
        </div>
        
        <div class="history-section">
            <button id="historyBtn">Tap to See History of All Users</button>
            <div id="historyList" class="hidden">
                <h3>All Users' Names & Wishlists</h3>
                <div id="userGrid"></div>
            </div>
        </div>
    </div>
    <script>
        // Load current user
        let currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            alert('No user data found. Please register first.');
            window.location.href = 'index.html';
        }
        
        document.getElementById('userName').textContent = currentUser.name;
        
        // Check history visibility
        const historyVisible = localStorage.getItem('historyVisible') === 'true';
        const historyList = document.getElementById('historyList');
        if (historyVisible) {
            historyList.classList.remove('hidden');
        }
        
        // Load history
        function loadHistory() {
            const userGrid = document.getElementById('userGrid');
            userGrid.innerHTML = '<p>Loading...</p>';
            
            if (window.db) {
                try {
                    onSnapshot(collection(window.db, 'users'), (snapshot) => {
                        userGrid.innerHTML = '';
                        snapshot.forEach((doc) => {
                            const user = doc.data();
                            const userCard = document.createElement('div');
                            userCard.className = 'user-card';
                            userCard.innerHTML = `
                                <h4>${user.name}</h4>
                                <p><strong>Wishlist:</strong> ${user.wishlist || 'None yet'}</p>
                            `;
                            userGrid.appendChild(userCard);
                        });
                    });
                } catch (error) {
                    console.error("Firebase load error:", error);
                    alert("Firebase error. Falling back to local.");
                    loadLocalHistory();
                }
            } else {
                loadLocalHistory();
            }
        }
        
        function loadLocalHistory() {
            const users = JSON.parse(localStorage.getItem('christmasUsers')) || [];
            const userGrid = document.getElementById('userGrid');
            userGrid.innerHTML = '';
            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <h4>${user.name}</h4>
                    <p><strong>Wishlist:</strong> ${user.wishlist || 'None yet'}</p>
                `;
                userGrid.appendChild(userCard);
            });
        }
        
        if (historyVisible) {
            loadHistory();
        }
        
        // Submit wishlist
        document.getElementById('submitWishlist').addEventListener('click', async function() {
            const wishlistText = document.getElementById('wishlist').value;
            currentUser.wishlist = wishlistText;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            try {
                if (window.db) {
                    await setDoc(doc(window.db, 'users', currentUser.email), currentUser);
                    alert('Wishlist saved and synced!');
                } else {
                    let users = JSON.parse(localStorage.getItem('christmasUsers')) || [];
                    const index = users.findIndex(u => u.email === currentUser.email);
                    if (index !== -1) {
                        users[index] = currentUser;
                        localStorage.setItem('christmasUsers', JSON.stringify(users));
                    }
                    alert('Wishlist saved locally!');
                }
            } catch (error) {
                console.error("Save error:", error);
                alert("Save failed. Using local. Details: " + error.message);
                // Fallback
                let users = JSON.parse(localStorage.getItem('christmasUsers')) || [];
                const index = users.findIndex(u => u.email === currentUser.email);
                if (index !== -1) {
                    users[index] = currentUser;
                    localStorage.setItem('christmasUsers', JSON.stringify(users));
                }
            }
        });
        
        // History toggle
        const historyBtn = document.getElementById('historyBtn');
        historyBtn.addEventListener('click', function() {
            const isHidden = historyList.classList.contains('hidden');
            if (isHidden) {
                historyList.classList.remove('hidden');
                loadHistory();
                localStorage.setItem('historyVisible', 'true');
            } else {
                historyList.classList.add('hidden');
                localStorage.setItem('historyVisible', 'false');
            }
        });
        
        // Load user's wishlist on page load
        (async () => {
            try {
                if (window.db) {
                    const docRef = doc(window.db, 'users', currentUser.email);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('wishlist').value = data.wishlist || '';
                        currentUser = data;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    } else {
                        await setDoc(doc(window.db, 'users', currentUser.email), currentUser);
                    }
                }
            } catch (error) {
                console.error("Load wishlist error:", error);
                // No alert, just use local
            }
        })();
    </script>
</body>
</html>
