<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Gift Exchange Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase Scripts -->
    <script type="module">
      // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCOxCavlsWWB662RO15X4iDcSZFrtH2uTI",
  authDomain: "christmasgiftexchange-8d38e.firebaseapp.com",
  projectId: "christmasgiftexchange-8d38e",
  storageBucket: "christmasgiftexchange-8d38e.firebasestorage.app",
  messagingSenderId: "184610390168",
  appId: "1:184610390168:web:fc87da7d2c88db285790ed",
  measurementId: "G-XYBRD248ES"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

        window.db = db; // Make db available globally for the script below
    </script>
</head>
<body>
    <div class="container">
        <img src="https://via.placeholder.com/800x300/228B22/FFFFFF?text=Christmas+Tree" alt="Christmas Tree" class="top-image">
        
        <div class="user-info">
            <h2 id="userName"></h2>
            <label for="wishlist">Your Wishlist:</label>
            <textarea id="wishlist" placeholder="Add your gift wishes here..."></textarea>
            <button id="submitWishlist">Submit Wishlist</button>
        </div>
        
        <div class="history-section">
            <button id="historyBtn">Tap to See History of All Users</button>
            <div id="historyList" class="hidden">
                <h3>All Users' Names & Wishlists</h3>
                <div id="userGrid"></div>
            </div>
        </div>
    </div>
    <script>
        // Load current user from localStorage (for session)
        let currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            alert('No user data found. Please register first.');
            window.location.href = 'index.html';
        }
        
        document.getElementById('userName').textContent = currentUser.name;
        
        // Check if history was open on last visit
        const historyVisible = localStorage.getItem('historyVisible') === 'true';
        const historyList = document.getElementById('historyList');
        if (historyVisible) {
            historyList.classList.remove('hidden');
        }
        
        // Function to load and display all users from Firebase (real-time)
        function loadHistory() {
            const userGrid = document.getElementById('userGrid');
            userGrid.innerHTML = '<p>Loading...</p>';
            
            if (window.db) {
                // Real-time listener for all users
                onSnapshot(collection(window.db, 'users'), (snapshot) => {
                    userGrid.innerHTML = '';
                    snapshot.forEach((doc) => {
                        const user = doc.data();
                        const userCard = document.createElement('div');
                        userCard.className = 'user-card';
                        userCard.innerHTML = `
                            <h4>${user.name}</h4>
                            <p><strong>Wishlist:</strong> ${user.wishlist || 'None yet'}</p>
                        `;
                        userGrid.appendChild(userCard);
                    });
                });
            } else {
                // Fallback to localStorage if Firebase not set up
                const users = JSON.parse(localStorage.getItem('christmasUsers')) || [];
                userGrid.innerHTML = '';
                users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card';
                    userCard.innerHTML = `
                        <h4>${user.name}</h4>
                        <p><strong>Wishlist:</strong> ${user.wishlist || 'None yet'}</p>
                    `;
                    userGrid.appendChild(userCard);
                });
            }
        }
        
        // Load history if visible on page load
        if (historyVisible) {
            loadHistory();
        }
        
        // Submit wishlist
        document.getElementById('submitWishlist').addEventListener('click', async function() {
            const wishlistText = document.getElementById('wishlist').value;
            currentUser.wishlist = wishlistText;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            if (window.db) {
                // Save to Firebase
                await setDoc(doc(window.db, 'users', currentUser.email), currentUser);
                alert('Wishlist saved and synced!');
            } else {
                // Fallback to localStorage
                let users = JSON.parse(localStorage.getItem('christmasUsers')) || [];
                const index = users.findIndex(u => u.email === currentUser.email);
                if (index !== -1) {
                    users[index] = currentUser;
                    localStorage.setItem('christmasUsers', JSON.stringify(users));
                }
                alert('Wishlist saved locally!');
            }
        });
        
        // History toggle
        const historyBtn = document.getElementById('historyBtn');
        historyBtn.addEventListener('click', function() {
            const isHidden = historyList.classList.contains('hidden');
            if (isHidden) {
                historyList.classList.remove('hidden');
                loadHistory(); // Load data when opening
                localStorage.setItem('historyVisible', 'true');
            } else {
                historyList.classList.add('hidden');
                localStorage.setItem('historyVisible', 'false');
            }
        });
        
        // Load current user's wishlist from Firebase on page load
        if (window.db) {
            const docRef = doc(window.db, 'users', currentUser.email);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('wishlist').value = data.wishlist || '';
                currentUser = data; // Update local
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } else {
                // If not in Firebase, save current user
                await setDoc(doc(window.db, 'users', currentUser.email), currentUser);
            }
        }
    </script>
</body>
</html>


